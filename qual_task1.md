# Overview

SRC qualification 1 is an image processing task. The qualification loads with R5 standing in front of a console. Located on the console are a number of LEDs and screens, all of which are black. 

The task is started when an empty message is sent to the `/srcsim/qual1/start` topic. At this point the large screen in the center of the console will turn white. This transition signals that the task is starting.

One at a time, LEDs will turn on then off. An LED will stay on between 5 and 20 seconds. The color of the LED will be either red, green, or blue. During this time, you must report the color and center location of the LED relative to R5's head frame in meters. Color values are in the range of (0,1). For example, red is `r=1, g=0, b=0`. Score is based on the accuracy of the reported locations and color.

**Important Note**

Raw image data is inverted, due to the multisense head being mounted up-side-down. Make sure to adjust the image data correctly in order to arrive at physically accurate LED positions.


![4007635085-srcsim_qual1_console_yellow.jpg](https://bitbucket.org/repo/xEbAAe/images/3389508772-4007635085-srcsim_qual1_console_yellow.jpg)

The end of the task is marked by the center screen transitioning from white to black. At this point, no more LEDs will turn on, and it is safe to quite Gazebo and submit your results.

## Quickstart


1. Run the qualification task

    ```
source /opt/nasa/indigo/setup.bash
    ```

    ```
    roslaunch srcsim qual1.launch extra_gazebo_args:="-r" init:="true"
    ```

1. Test out signaling the start of the task

    ```
    rostopic pub /srcsim/qual1/start std_msgs/Empty
    ```

1. Write a program to solve the task

1. Rerun the qualification task and run your solution.

1. Submit the two log files described in the **Upload your log files** section below.

## 2D Image Processing

Refer to the [API](https://bitbucket.org/osrf/srcsim/wiki/api) for a topic that publishes camera data. Subscribe to this topic by registering a callback. The callback will receive camera image data when the data is available. Refer to the [ROS Publisher Subscriber Tutorial](http://wiki.ros.org/ROS/Tutorials/WritingPublisherSubscriber%28c%2B%2B%29) for more details on nodes, publishers, and subscribers.

Make use of any image processing library, such as [OpenCV](http://opencv.org), to determine if an LED is on and where in the image the LED is located.

**Important Note**

Raw image data is inverted, due to the multisense head being mounted up-side-down. Make sure to adjust the image data correctly in order to arrive at physically accurate LED positions.

## Depth data

R5 comes equipped with a stereo camera and a spinning hokuyo laser. Make use of these sensors to determine where an LED is located.

## Reporting LED color and location

Send the location, in meters relative to the head frame of R3, and color, using a range of (0,1) for each RGB component, of each LED to the `/srcsim/qual1/light` topic. This topic expects a [srcsim/Console](https://bitbucket.org/osrf/srcsim/src/56895b58f7654df5a54934c562591020a558fde7/msg/Console.msg?at=default&fileviewer=file-view-default) message. Your answer will appear in a log file that you must submit in order to complete the qualification tasks. This log file is in your home directory with the name `src_qual1_<timestamp>.log`, where `<timestamp>` is an ISO string of the time that simulation started.

**Important Note**

Raw image data is inverted, due to the multisense head being mounted up-side-down. Make sure to adjust the image data correctly in order to arrive at physically accurate LED positions.


## Upload your log files

A submission for qual task 1 requires two files. The first is a text file that contains information about the LEDs and your reported LED locations. The second file contains simulation state information.

#### 1. LED answer log file

A new file in your home directory appears with the name `src_qual1_<timestamp>.log` after each time qual task 1 is run. Make sure you submit the correct `src_qual1_<timestamp>.log` file along with your simulation state log file.

#### 2. Simulation state log file

You need to add the parameter `extra_gazebo_args:="-r"` to roslaunch to enable Gazebo logging. When you're ready to start your SRC task with logging enable, type:


```
#!c++

roslaunch srcsim qual1.launch extra_gazebo_args:="-r" init:="true"
```

A log file is written at ~/.gazebo/log/<timestamp>/gzserver/state.log . You can verify that your log file has been properly generated by loading it into Gazebo:

```
#!c++

gazebo -p ~/.gazebo/log/<timestamp>/gzserver/state.log
```

It's highly recommended to playback your log files before submission.

The size of a log file can be really big depending on the complexity of the world. For submission, we'll reduce the size of the log file by sampling at lower rate and filtering some of the information. Run the following command inside the folder where your log file was created. 


```
#!c++

gz log -e -f state.log --filter *.pose/*.pose > qual_1.log
```

And then, compress your file:

```
#!c++

gzip -c qual_1.log > qual_1.log.gz
```

Always save the original log and submit the filtered log (`qual_1.log.gz`).

# Check your score

It's possible to execute a script that tells you the score that you obtained after running a task. We encourage teams to check the score before submission to make sure that your log file is correct and your score looks reasonable.

Create a directory for storing the scoring scripts:


```
#!c++

mkdir ~/srcsim_score && cd ~/srcsim_score
```


Download the following ruby scripts:


```
#!c++

wget https://bitbucket.org/osrf/srcsim/raw/score/scoring/common.rb
wget https://bitbucket.org/osrf/srcsim/raw/score/scoring/scoring_q1.rb
```

Install the following dependencies:


```
#!c++

sudo apt-get install ruby-nokogiri
```


Make the scoring script executable:


```
#!c++

chmod +x scoring_q1.rb
```

Check your score, giving to the script the previously generated files:


```
#!c++

./scoring_q1.rb <path_to>/src_qual1_<timestamp>.log <path_to>/qual_1.log

```

The output of the script should tell you:

* the total duration of the task
* whether it was a success or a failure
* the total score for the color tasks
* the total score for the position tasks 
* the total score for qualification 1.


```
#!c++

Duration: 27.569000000
Success: No
Color score: 1.000000 / 1.0
Position score: 0.500000 / 1.0
Total score: 0.750000 / 1.0
```
